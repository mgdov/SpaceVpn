{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/ab/Documents/code/SpaceVPN/SpaceVpn/lib/api.ts"],"sourcesContent":["/**\n * API Client for SpaceVPN Backend\n *\n * IMPORTANT: Always use relative paths for API requests\n * to work correctly behind the nginx reverse proxy\n */\n\n// nginx proxies /api/v1/* to the backend\nexport const API_BASE_URL = '/api/v1'\n\nexport interface ApiResponse<T = any> {\n  data?: T\n  error?: string\n  message?: string\n  status?: number\n}\n\nexport interface User {\n  id: number\n  username: string\n  email: string | null\n  full_name: string | null\n  is_active: boolean\n  is_superuser: boolean\n  created_at: string\n  updated_at: string\n}\n\nexport interface TokenResponse {\n  access_token: string\n  token_type: string\n}\n\nexport interface Tariff {\n  id: number\n  name: string\n  description: string | null\n  tagline?: string | null\n  duration_months: number\n  price: number\n  data_limit_gb: number\n  devices_count?: number\n  is_active?: boolean\n  is_featured?: boolean\n  features?: string | null\n}\n\nexport interface VPNClient {\n  id: number\n  user_id: number\n  subscription_id: number\n  client_uuid: string\n  pasarguard_username?: string | null\n  name: string\n  device_info?: string | null\n  subscription_url?: string | null\n  last_connected_at?: string | null\n  created_at: string\n  updated_at: string\n}\n\nexport interface VPNConfig {\n  client_uuid: string\n  name: string\n  xray_config: any  // JSON object\n  subscription_url: string  // VLESS URL\n  qr_code: string  // Base64 encoded image\n}\n\nexport interface Subscription {\n  id: number\n  user_id: number\n  pasarguard_username?: string | null\n  plan: string  // SubscriptionPlan enum value\n  status: string  // SubscriptionStatus enum value\n  data_limit?: number | null  // bytes, null = unlimited\n  used_traffic: number  // bytes\n  start_date: string\n  expire_date?: string | null\n  is_active: boolean\n  traffic_remaining?: number | null\n  traffic_used_percentage?: number | null\n  created_at: string\n  updated_at: string\n}\n\nexport interface AdminSubscription extends Subscription {\n  user?: User\n}\n\nexport interface HealthResponse {\n  status: string\n  uptime?: number\n  version?: string\n}\n\nexport interface ApiInfoResponse {\n  version: string\n  status: string\n  uptime?: number\n}\n\nexport interface UpdateProfilePayload {\n  email?: string | null\n  username?: string\n  full_name?: string | null\n  password?: string\n  current_password?: string\n}\n\nexport interface CreateSubscriptionPayload {\n  plan: string  // SubscriptionPlan: \"free\" | \"basic\" | \"premium\" | \"unlimited\"\n}\n\nexport interface UpdateSubscriptionPayload {\n  tariff_id?: string\n  end_date?: string\n  is_active?: boolean\n  data_limit_gb?: number\n}\n\nexport interface CreateVPNClientPayload {\n  subscription_id: number\n  name: string\n  device_info?: string\n}\n\nexport interface UpdateVPNClientPayload {\n  name?: string\n  device_info?: string\n}\n\nexport interface CreateTariffPayload {\n  name: string\n  duration_months: number\n  price: number\n  description?: string | null\n  tagline?: string | null\n  data_limit_gb?: number\n  devices_count?: number\n  is_active?: boolean\n  is_featured?: boolean\n  sort_order?: number\n  features?: string | null\n}\n\nexport type UpdateTariffPayload = Partial<CreateTariffPayload>\n\nexport type AdminVPNClient = VPNClient & { user?: User }\n\nexport interface ExtendPayload {\n  days?: number\n  expires_at?: string\n}\n\nexport interface PasarguardSyncResponse {\n  synced: number\n  failed?: number\n  skipped?: number\n}\n\ntype QueryParams = Record<string, string | number | boolean | undefined>\n\nfunction buildEndpoint(endpoint: string): string {\n  const base = API_BASE_URL.endsWith('/') ? API_BASE_URL.slice(0, -1) : API_BASE_URL\n  if (!endpoint || endpoint === '/') {\n    return `${base}/`\n  }\n  const normalized = endpoint.startsWith('/') ? endpoint : `/${endpoint}`\n  return `${base}${normalized}`\n}\n\nfunction withQuery(endpoint: string, params?: QueryParams): string {\n  if (!params) return endpoint\n  const search = new URLSearchParams()\n  Object.entries(params).forEach(([key, value]) => {\n    if (value === undefined || value === null) return\n    search.append(key, String(value))\n  })\n  const query = search.toString()\n  return query ? `${endpoint}?${query}` : endpoint\n}\n\n/**\n * Get auth token from localStorage\n */\nexport function getAuthToken(): string | null {\n  if (typeof window === 'undefined') return null\n  return localStorage.getItem('auth_token')\n}\n\n/**\n * Set auth token in localStorage\n */\nexport function setAuthToken(token: string): void {\n  if (typeof window === 'undefined') return\n  localStorage.setItem('auth_token', token)\n}\n\n/**\n * Remove auth token from localStorage\n */\nexport function removeAuthToken(): void {\n  if (typeof window === 'undefined') return\n  localStorage.removeItem('auth_token')\n}\n\n/**\n * Get current user from localStorage\n */\nexport function getCurrentUser(): User | null {\n  if (typeof window === 'undefined') return null\n  const userJson = localStorage.getItem('current_user')\n  return userJson ? JSON.parse(userJson) : null\n}\n\n/**\n * Set current user in localStorage\n */\nexport function setCurrentUser(user: User): void {\n  if (typeof window === 'undefined') return\n  localStorage.setItem('current_user', JSON.stringify(user))\n}\n\n/**\n * Remove current user from localStorage\n */\nexport function removeCurrentUser(): void {\n  if (typeof window === 'undefined') return\n  localStorage.removeItem('current_user')\n}\n\nfunction safeParseJson(payload: string) {\n  try {\n    return JSON.parse(payload)\n  } catch {\n    return payload\n  }\n}\n\n/**\n * Make authenticated API request\n */\nasync function apiRequest<T = any>(endpoint: string, options: RequestInit = {}): Promise<ApiResponse<T>> {\n  const token = getAuthToken()\n  const isFormData = typeof FormData !== 'undefined' && options.body instanceof FormData\n\n  const headers = new Headers(options.headers || {})\n  if (!headers.has('Accept')) {\n    headers.set('Accept', 'application/json')\n  }\n\n  const hasBody = options.body !== undefined && options.body !== null && options.body !== ''\n  if (!isFormData && hasBody && !headers.has('Content-Type')) {\n    headers.set('Content-Type', 'application/json')\n  }\n\n  if (token && !headers.has('Authorization')) {\n    headers.set('Authorization', `Bearer ${token}`)\n  }\n\n  try {\n    const response = await fetch(buildEndpoint(endpoint), {\n      ...options,\n      headers,\n    })\n\n    const status = response.status\n    const raw = await response.text()\n    const payload = raw ? safeParseJson(raw) : undefined\n\n    if (!response.ok) {\n      if (status === 422 && Array.isArray((payload as any)?.detail)) {\n        const errors = (payload as any).detail\n          .map((err: any) => `${err.loc?.join(' → ') || 'Field'}: ${err.msg}`)\n          .join(', ')\n        return { error: errors, status }\n      }\n\n      const detail =\n        (payload as any)?.detail ||\n        (payload as any)?.message ||\n        (Array.isArray((payload as any)?.errors) ? (payload as any)?.errors.join(', ') : undefined)\n\n      return { error: typeof detail === 'string' ? detail : `HTTP ${status}`, status }\n    }\n\n    return { data: payload as T, status }\n  } catch (error) {\n    return {\n      error: error instanceof Error ? error.message : 'Network error',\n    }\n  }\n}\n\n/**\n * Authentication helpers\n */\nexport async function registerUser(\n  username: string,\n  email: string,\n  password: string,\n  fullName?: string\n): Promise<ApiResponse<User>> {\n  return apiRequest<User>('/auth/register', {\n    method: 'POST',\n    body: JSON.stringify({ username, email, password, full_name: fullName }),\n  })\n}\n\nexport async function loginUser(username: string, password: string): Promise<ApiResponse<TokenResponse>> {\n  const formData = new URLSearchParams()\n  formData.append('username', username)\n  formData.append('password', password)\n\n  const response = await apiRequest<TokenResponse>('/auth/token', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n    },\n    body: formData.toString(),\n  })\n\n  if (response.data?.access_token) {\n    setAuthToken(response.data.access_token)\n  }\n\n  return response\n}\n\nexport function logoutUser(): void {\n  removeAuthToken()\n  removeCurrentUser()\n}\n\nexport function isAuthenticated(): boolean {\n  return getAuthToken() !== null\n}\n\n/**\n * User profile endpoints\n */\nexport async function getCurrentUserInfo(): Promise<ApiResponse<User>> {\n  const response = await apiRequest<User>('/users/me')\n  if (response.data) {\n    setCurrentUser(response.data)\n  }\n  return response\n}\n\nexport async function updateCurrentUser(payload: UpdateProfilePayload): Promise<ApiResponse<User>> {\n  const response = await apiRequest<User>('/users/me', {\n    method: 'PUT',\n    body: JSON.stringify(payload),\n  })\n\n  if (response.data) {\n    setCurrentUser(response.data)\n  }\n\n  return response\n}\n\nexport async function getUserById(userId: string): Promise<ApiResponse<User>> {\n  return apiRequest<User>(`/users/${userId}`)\n}\n\nexport async function deleteUserById(userId: string): Promise<ApiResponse<void>> {\n  return apiRequest<void>(`/users/${userId}`, { method: 'DELETE' })\n}\n\nexport async function adminListUsers(params?: QueryParams): Promise<ApiResponse<User[]>> {\n  return apiRequest<User[]>(withQuery('/admin/users', params))\n}\n\nexport async function adminGetUser(userId: string): Promise<ApiResponse<User>> {\n  return apiRequest<User>(`/admin/users/${userId}`)\n}\n\nexport async function adminDeleteUser(userId: string): Promise<ApiResponse<void>> {\n  return apiRequest<void>(`/admin/users/${userId}`, { method: 'DELETE' })\n}\n\nexport async function adminToggleUserActive(userId: string): Promise<ApiResponse<User>> {\n  return apiRequest<User>(`/admin/users/${userId}/toggle-active`, { method: 'POST' })\n}\n\nexport async function adminMakeSuperuser(userId: string): Promise<ApiResponse<User>> {\n  return apiRequest<User>(`/admin/users/${userId}/make-superuser`, { method: 'POST' })\n}\n\n/**\n * Subscription endpoints (user)\n */\nexport async function getUserSubscriptions(): Promise<ApiResponse<Subscription[]>> {\n  return apiRequest<Subscription[]>('/subscriptions')\n}\n\nexport async function getSubscriptionById(id: string): Promise<ApiResponse<Subscription>> {\n  return apiRequest<Subscription>(`/subscriptions/${id}`)\n}\n\nexport async function createSubscription(payload: CreateSubscriptionPayload): Promise<ApiResponse<Subscription>> {\n  return apiRequest<Subscription>('/subscriptions', {\n    method: 'POST',\n    body: JSON.stringify(payload),\n  })\n}\n\nexport async function updateSubscription(\n  id: string,\n  payload: UpdateSubscriptionPayload\n): Promise<ApiResponse<Subscription>> {\n  return apiRequest<Subscription>(`/subscriptions/${id}`, {\n    method: 'PUT',\n    body: JSON.stringify(payload),\n  })\n}\n\nexport async function deleteSubscription(id: string): Promise<ApiResponse<void>> {\n  return apiRequest<void>(`/subscriptions/${id}`, { method: 'DELETE' })\n}\n\n/**\n * Subscription endpoints (admin)\n */\nexport async function adminListSubscriptions(): Promise<ApiResponse<AdminSubscription[]>> {\n  return apiRequest<AdminSubscription[]>('/admin/subscriptions')\n}\n\nexport async function adminGetSubscription(id: string): Promise<ApiResponse<AdminSubscription>> {\n  return apiRequest<AdminSubscription>(`/admin/subscriptions/${id}`)\n}\n\nexport async function adminCreateSubscription(\n  payload: CreateSubscriptionPayload\n): Promise<ApiResponse<AdminSubscription>> {\n  return apiRequest<AdminSubscription>('/admin/subscriptions', {\n    method: 'POST',\n    body: JSON.stringify(payload),\n  })\n}\n\nexport async function adminDeleteSubscription(id: string): Promise<ApiResponse<void>> {\n  return apiRequest<void>(`/admin/subscriptions/${id}`, { method: 'DELETE' })\n}\n\nexport async function adminExtendSubscription(\n  id: string,\n  payload?: ExtendPayload\n): Promise<ApiResponse<AdminSubscription>> {\n  return apiRequest<AdminSubscription>(`/admin/subscriptions/${id}/extend`, {\n    method: 'POST',\n    body: payload ? JSON.stringify(payload) : undefined,\n  })\n}\n\nexport async function adminToggleSubscription(id: string): Promise<ApiResponse<AdminSubscription>> {\n  return apiRequest<AdminSubscription>(`/admin/subscriptions/${id}/toggle`, {\n    method: 'POST',\n  })\n}\n\n/**\n * Tariff endpoints\n */\nexport async function getPublicTariffs(): Promise<ApiResponse<Tariff[]>> {\n  return apiRequest<Tariff[]>('/tariffs')\n}\n\nexport async function getPublicTariffById(id: string): Promise<ApiResponse<Tariff>> {\n  return apiRequest<Tariff>(`/tariffs/${id}`)\n}\n\nexport async function adminListTariffs(): Promise<ApiResponse<Tariff[]>> {\n  return apiRequest<Tariff[]>('/admin/tariffs')\n}\n\nexport async function adminCreateTariff(payload: CreateTariffPayload): Promise<ApiResponse<Tariff>> {\n  return apiRequest<Tariff>('/admin/tariffs', {\n    method: 'POST',\n    body: JSON.stringify(payload),\n  })\n}\n\nexport async function adminUpdateTariff(\n  id: string,\n  payload: UpdateTariffPayload\n): Promise<ApiResponse<Tariff>> {\n  return apiRequest<Tariff>(`/admin/tariffs/${id}`, {\n    method: 'PATCH',\n    body: JSON.stringify(payload),\n  })\n}\n\nexport async function adminDeleteTariff(id: string): Promise<ApiResponse<void>> {\n  return apiRequest<void>(`/admin/tariffs/${id}`, { method: 'DELETE' })\n}\n\nexport async function adminToggleTariff(id: string): Promise<ApiResponse<Tariff>> {\n  return apiRequest<Tariff>(`/admin/tariffs/${id}/toggle`, { method: 'POST' })\n}\n\n/**\n * VPN client endpoints (user)\n */\nexport async function listUserVPNClients(): Promise<ApiResponse<VPNClient[]>> {\n  return apiRequest<VPNClient[]>('/vpn-clients')\n}\n\nexport async function getUserVPNClient(id: string): Promise<ApiResponse<VPNClient>> {\n  return apiRequest<VPNClient>(`/vpn-clients/${id}`)\n}\n\nexport async function createUserVPNClient(\n  payload?: CreateVPNClientPayload\n): Promise<ApiResponse<VPNClient>> {\n  return apiRequest<VPNClient>('/vpn-clients', {\n    method: 'POST',\n    body: payload ? JSON.stringify(payload) : undefined,\n  })\n}\n\nexport async function updateUserVPNClient(\n  id: string,\n  payload: UpdateVPNClientPayload\n): Promise<ApiResponse<VPNClient>> {\n  return apiRequest<VPNClient>(`/vpn-clients/${id}`, {\n    method: 'PUT',\n    body: JSON.stringify(payload),\n  })\n}\n\nexport async function deleteUserVPNClient(id: string): Promise<ApiResponse<void>> {\n  return apiRequest<void>(`/vpn-clients/${id}`, { method: 'DELETE' })\n}\n\nexport async function getUserVPNClientConfig(id: string): Promise<ApiResponse<VPNConfig>> {\n  return apiRequest<VPNConfig>(`/vpn-clients/${id}/config`)\n}\n\nexport async function regenerateUserVPNClient(id: string): Promise<ApiResponse<VPNConfig>> {\n  return apiRequest<VPNConfig>(`/vpn-clients/${id}/regenerate`, { method: 'POST' })\n}\n\nexport async function syncUserVPNClient(id: string): Promise<ApiResponse<VPNClient>> {\n  return apiRequest<VPNClient>(`/vpn-clients/${id}/sync`, { method: 'POST' })\n}\n\n/**\n * VPN client endpoints (admin)\n */\nexport async function adminListVPNClients(): Promise<ApiResponse<AdminVPNClient[]>> {\n  return apiRequest<AdminVPNClient[]>('/admin/vpn/clients')\n}\n\nexport async function adminGetVPNClient(id: string): Promise<ApiResponse<AdminVPNClient>> {\n  return apiRequest<AdminVPNClient>(`/admin/vpn/clients/${id}`)\n}\n\nexport async function adminCreateVPNClient(\n  payload: CreateVPNClientPayload\n): Promise<ApiResponse<AdminVPNClient>> {\n  return apiRequest<AdminVPNClient>('/admin/vpn/clients', {\n    method: 'POST',\n    body: JSON.stringify(payload),\n  })\n}\n\nexport async function adminUpdateVPNClient(\n  id: string,\n  payload: UpdateVPNClientPayload\n): Promise<ApiResponse<AdminVPNClient>> {\n  return apiRequest<AdminVPNClient>(`/admin/vpn/clients/${id}`, {\n    method: 'PUT',\n    body: JSON.stringify(payload),\n  })\n}\n\nexport async function adminDeleteVPNClient(id: string): Promise<ApiResponse<void>> {\n  return apiRequest<void>(`/admin/vpn/clients/${id}`, { method: 'DELETE' })\n}\n\nexport async function adminExtendVPNClient(\n  id: string,\n  payload?: ExtendPayload\n): Promise<ApiResponse<AdminVPNClient>> {\n  return apiRequest<AdminVPNClient>(`/admin/vpn/clients/${id}/extend`, {\n    method: 'POST',\n    body: payload ? JSON.stringify(payload) : undefined,\n  })\n}\n\nexport async function adminToggleVPNClient(id: string): Promise<ApiResponse<AdminVPNClient>> {\n  return apiRequest<AdminVPNClient>(`/admin/vpn/clients/${id}/toggle`, {\n    method: 'POST',\n  })\n}\n\n/**\n * Internal maintenance endpoints\n */\nexport async function syncAllVpnClients(): Promise<ApiResponse<PasarguardSyncResponse>> {\n  return apiRequest<PasarguardSyncResponse>('/internal/pasarguard/sync', { method: 'POST' })\n}\n\n/**\n * Health & meta endpoints\n */\nexport async function getHealthStatus(): Promise<ApiResponse<HealthResponse>> {\n  return apiRequest<HealthResponse>('/health')\n}\n\nexport async function getApiInfo(): Promise<ApiResponse<ApiInfoResponse>> {\n  return apiRequest<ApiInfoResponse>('/')\n}\n\nexport interface CreateYookassaPaymentPayload {\n  tariffId: number\n  plan: string\n  price: number\n  description?: string\n}\n\nexport interface CreateYookassaPaymentResponse {\n  payment_id: string\n  confirmation_url: string\n  status?: string\n}\n\nexport interface ConfirmYookassaPaymentResponse {\n  success: boolean\n  plan?: string\n  subscription?: Subscription\n  message?: string\n}\n\nexport async function createYookassaPayment(\n  payload: CreateYookassaPaymentPayload\n): Promise<ApiResponse<CreateYookassaPaymentResponse>> {\n  const token = getAuthToken()\n  if (!token) {\n    return { error: 'Требуется авторизация для оплаты' }\n  }\n\n  try {\n    const response = await fetch('/api/yookassa/create-payment', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${token}`,\n      },\n      body: JSON.stringify(payload),\n    })\n\n    const data = await response.json().catch(() => ({}))\n    if (!response.ok) {\n      return { error: data?.error || data?.message || `HTTP ${response.status}` }\n    }\n\n    return { data }\n  } catch (error) {\n    return { error: error instanceof Error ? error.message : 'Network error' }\n  }\n}\n\nexport async function confirmYookassaPayment(\n  paymentId: string\n): Promise<ApiResponse<ConfirmYookassaPaymentResponse>> {\n  const token = getAuthToken()\n  if (!token) {\n    return { error: 'Требуется авторизация для оплаты' }\n  }\n\n  try {\n    const response = await fetch('/api/yookassa/confirm-payment', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${token}`,\n      },\n      body: JSON.stringify({ paymentId }),\n    })\n\n    const data = await response.json().catch(() => ({}))\n    if (!response.ok) {\n      return { error: data?.error || data?.message || `HTTP ${response.status}` }\n    }\n\n    return { data }\n  } catch (error) {\n    return { error: error instanceof Error ? error.message : 'Network error' }\n  }\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 547, "column": 0}, "map": {"version":3,"sources":["file:///Users/ab/Documents/code/SpaceVPN/SpaceVpn/lib/auth-context.tsx"],"sourcesContent":["\"use client\"\n\nimport React, { createContext, useContext, useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport {\n  User,\n  getCurrentUserInfo,\n  loginUser as apiLoginUser,\n  logoutUser as apiLogoutUser,\n  registerUser as apiRegisterUser,\n  isAuthenticated,\n  getAuthToken,\n  getCurrentUser as getStoredUser,\n} from './api'\n\ninterface AuthContextType {\n  user: User | null\n  loading: boolean\n  login: (username: string, password: string) => Promise<{ success: boolean; error?: string }>\n  logout: () => void\n  register: (username: string, email: string, password: string, fullName?: string) => Promise<{ success: boolean; error?: string }>\n  refreshUser: () => Promise<void>\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined)\n\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n  const [user, setUser] = useState<User | null>(null)\n  const [loading, setLoading] = useState(true)\n  const router = useRouter()\n\n  // Load user on mount\n  useEffect(() => {\n    const loadUser = async () => {\n      if (isAuthenticated()) {\n        // Try to load from localStorage first\n        const storedUser = getStoredUser()\n        if (storedUser) {\n          setUser(storedUser)\n        }\n\n        // Then refresh from API\n        const response = await getCurrentUserInfo()\n        if (response.data) {\n          setUser(response.data)\n        } else if (response.error) {\n          // Token expired or invalid\n          apiLogoutUser()\n          setUser(null)\n        }\n      }\n      setLoading(false)\n    }\n\n    loadUser()\n  }, [])\n\n  const login = async (username: string, password: string) => {\n    setLoading(true)\n    try {\n      const response = await apiLoginUser(username, password)\n      \n      if (response.data) {\n        // Get user info after login\n        const userResponse = await getCurrentUserInfo()\n        if (userResponse.data) {\n          setUser(userResponse.data)\n          setLoading(false)\n          return { success: true }\n        }\n      }\n      \n      setLoading(false)\n      return { success: false, error: response.error || 'Login failed' }\n    } catch (error) {\n      setLoading(false)\n      return { success: false, error: error instanceof Error ? error.message : 'Login failed' }\n    }\n  }\n\n  const logout = () => {\n    apiLogoutUser()\n    setUser(null)\n    router.push('/login')\n  }\n\n  const register = async (username: string, email: string, password: string, fullName?: string) => {\n    setLoading(true)\n    try {\n      const response = await apiRegisterUser(username, email, password, fullName)\n      \n      if (response.data) {\n        // Auto-login after registration\n        const loginResult = await login(username, password)\n        return loginResult\n      }\n      \n      setLoading(false)\n      return { success: false, error: response.error || 'Registration failed' }\n    } catch (error) {\n      setLoading(false)\n      return { success: false, error: error instanceof Error ? error.message : 'Registration failed' }\n    }\n  }\n\n  const refreshUser = async () => {\n    if (isAuthenticated()) {\n      const response = await getCurrentUserInfo()\n      if (response.data) {\n        setUser(response.data)\n      }\n    }\n  }\n\n  return (\n    <AuthContext.Provider value={{ user, loading, login, logout, register, refreshUser }}>\n      {children}\n    </AuthContext.Provider>\n  )\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext)\n  if (context === undefined) {\n    throw new Error('useAuth must be used within an AuthProvider')\n  }\n  return context\n}\n\n// Protected route wrapper\nexport function withAuth<P extends object>(Component: React.ComponentType<P>) {\n  return function ProtectedRoute(props: P) {\n    const { user, loading } = useAuth()\n    const router = useRouter()\n\n    useEffect(() => {\n      if (!loading && !user) {\n        router.push('/login')\n      }\n    }, [user, loading, router])\n\n    if (loading) {\n      return (\n        <div className=\"min-h-screen flex items-center justify-center\">\n          <div className=\"text-muted-foreground\">Загрузка...</div>\n        </div>\n      )\n    }\n\n    if (!user) {\n      return null\n    }\n\n    return <Component {...props} />\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}